
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Classes for administrative functions for Tasking Manager style projects.">
      
      
      
        <link rel="canonical" href="https://www.hotosm.org/schema/">
      
      
        <link rel="prev" href="../endpoints/">
      
      
        <link rel="next" href="../structure/">
      
      
      <link rel="icon" href="../images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.8">
    
    
      
        <title>Database schema - tm-admin</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4b4a2bd9.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.356b1318.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../css/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#changing-the-tm-admin-schema" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="tm-admin" class="md-header__button md-logo" aria-label="tm-admin" data-md-component="logo">
      
  <img src="../images/hot_logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            tm-admin
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Database schema
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/hotosm/tm-admin/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    hotosm/tm-admin
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="tm-admin" class="md-nav__button md-logo" aria-label="tm-admin" data-md-component="logo">
      
  <img src="../images/hot_logo.png" alt="logo">

    </a>
    tm-admin
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/hotosm/tm-admin/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    hotosm/tm-admin
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Utilities
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Utilities
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../tmadmin-manage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tmadmin-manager
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../tmdb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tmdb
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../generator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    generator
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../getting_started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../importing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Importing TM data
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Deep Dives
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Deep Dives
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../build/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Building
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../configuring/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuring
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../communication/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Communication
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../dataflow/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Data Flow
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../dataexchange/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Data Exchange
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../endpoints/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Endpoints
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Database schema
  </span>
  

      </a>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    For Developers
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            For Developers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../structure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Code Structure
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../pgsupport/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Database Support
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3" >
        
          
          <label class="md-nav__link" for="__nav_7_3" id="__nav_7_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Code API
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3">
            <span class="md-nav__icon md-icon"></span>
            Code API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Top Level APIs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../api/projects/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Projects Table
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../api/tasks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tasks Table
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../api/users/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Users Table
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../api/campaigns/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Campaigns Table
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../api/messages/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Messages Table
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../api/organizations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Organizations Table
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../pgasync/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using asyncpg
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../protos-api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Protobuf API
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../apidocs/html/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Class Hierarchy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="https://docs.hotosm.org/dev-guide/version-control/#creating-releases" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Versioning
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../LICENSE/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    License
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../CHANGELOG/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Changelog
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="https://docs.hotosm.org/code-of-conduct" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Code of Conduct
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  

<nav class="md-nav md-nav--secondary" aria-label="Page contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="changing-the-tm-admin-schema">Changing The TM Admin Schema<a class="headerlink" href="#changing-the-tm-admin-schema" title="Permanent link">&para;</a></h1>
<p>This document covers how to make changes to the data schemas used in
TM Admin, and the changes that were made from the original Tasking
Manager (TM). The Field Mapping Tasking Manager (FMTM) database schema
was originally based on the TM schema, but doesn't use all the tables,
plus added columns. TM Admin has a unified schema that is designed to
work with any tasking manager style project.</p>
<h1 id="the-configuration-file">The configuration file<a class="headerlink" href="#the-configuration-file" title="Permanent link">&para;</a></h1>
<p>A simple YAML based config file is used as a single source for all the
data structures. This makes it easier to exchange data between
postgres, protobuf, and python. The format for configuring a schema is
explained in more detail in <a href="../configuring/">this document</a>. Any
changes to the config file are propogated into the different formats.</p>
<p>Updating the config file then requires regenerating all the output
files. After any changes to the config files, the test cases should be
run to make sure nothing breaks. If the config change is to support a
new internal API, then that new function should be added to the test
cases.</p>
<h2 id="merging-tables">Merging Tables<a class="headerlink" href="#merging-tables" title="Permanent link">&para;</a></h2>
<p>I've been experimenting with the tradeoffs between JSONB columns vs
nested tables in Postgres. The current Tasking Manager database schema
has multiple small two columns tables, most of those got turned into
arrays as I refactoring the schema. But some of the tables in TM are
larger like project_team or task_history. Those I had been using as a
nested array. The advantages, easy to query, you can see all the
columns in each table. Nested tables are being used to reduce needing
multiple SQL queries in series to get basic information. The downside
is a nested table has to exist in the database when the primary table
is created, so there is a dependency problem. It's also a touch
confusing, since when you list the tables, you have several of these
adding clutter. When doing a bulk insert of multiple tables, it's
messy dealing with the dependencies.</p>
<p>Since Postgres v12, there are new functions for dealing with JSONB
columns that I think make them better than nested tables. A JSONB
column doesn't need to be defined ahead of time, it's created
dynamically, so also easier to update in the future. They're also
fast, JSONB columns have their own index. The downside is the syntax
for accessing a JSONB column reminds me of AWK, write-once, difficult
to debug. You wind up with SQL like this:</p>
<div class="highlight"><pre><span></span><code>SELECT jsonb_path_query(team_members, &#39;$.members[*] ? (@.function[*] == &quot;MEMBER&quot; &amp;&amp; @.active==&quot;false&quot;)&#39;) AS player FROM teams WHERE &quot;id&quot; = 3;
</code></pre></div>
<p>I'm burying the SQL queries in a python module, but luckily at one
point implementing new queries is mostly cut &amp; paste with minor
editing for column names.</p>
<h2 id="the-types-files">The Types files<a class="headerlink" href="#the-types-files" title="Permanent link">&para;</a></h2>
<p>All of the enums have been extracted from FMTM and TM, and are defined
in the <em>types.yaml</em> file. This file must be processed before all the
others, since it defines custom data types all the other files depend
on. While the names of the types is the same across platforms, there
are minor differences in capitalization which are easily handled.</p>
<h3 id="types_tmsql">types_tm.sql<a class="headerlink" href="#types_tmsql" title="Permanent link">&para;</a></h3>
<p>This file contains the definitions for postgres. These add new types
into postgres, which can then be used by the other tables.</p>
<h3 id="types_tmpy">types_tm.py<a class="headerlink" href="#types_tmpy" title="Permanent link">&para;</a></h3>
<p>This file contains the definitions for python. These are standard
Python IntEnums, so it's possible to get both the name or the numeric
value.</p>
<h3 id="types_tmproto">types_tm.proto<a class="headerlink" href="#types_tmproto" title="Permanent link">&para;</a></h3>
<p>This file contains the protobuf definitions required by gRPC. These
are needed to compile any of the other protobuf files.</p>
<h2 id="regenerating-the-files">Regenerating the files<a class="headerlink" href="#regenerating-the-files" title="Permanent link">&para;</a></h2>
<p>After any changes to one of the config files, the various output files
must be generated. A utility program is included to regenerate all the
files, and then updates the database table schemas too. Note that this
will wipe any existing data, so is only used to initialize the
database.</p>
<div class="highlight"><pre><span></span><code>tmadmin-manager.py */*.yaml -v
</code></pre></div>
<p>If you just want to regenerate the output files to view a change, or
work with only one table, use the <em>generate.py</em> program. There is also
a base class <em>Generator</em> that can be used by other programs.</p>
<div class="highlight"><pre><span></span><code>generate.py users/users.yaml -v
</code></pre></div>
<h2 id="the-python-api">The Python API<a class="headerlink" href="#the-python-api" title="Permanent link">&para;</a></h2>
<p>There are two python files generated to work with the data structures
directly. One is a direct representation of the database table
schema. This is in the __<em><em>class.py_</em> file. Each one contains a class
for each table in the config file. For example, the *users</em> table has
a <strong>UsersTable</strong> class. Each column in the table is a parameter with a
default value, so the internal data is the same as the database. The
internal data stucture is used throughout TM Admin. When instantiating
an instance of this class, any column can be specified as a
parameter. This class is used to insert data into the table, to update
existing data, or to query data.</p>
<div class="highlight"><pre><span></span><code>ut = UsersTable(name=&#39;foobar&#39;, email_address=&quot;bar@foo.com&quot;, mapping_level=&#39;INTERMEDIATE&#39;)
</code></pre></div>
<p>The other is for managing protobuf messages. As a protobuf message
does not contain the full record from the table, these are similar to
the <strong>*Table</strong> class, but just have less fields in the data
structure. What is in the protobuf messages is defined in the config
file using the <a href="../configuring/">share keyword</a>. This is only used to
create and parse gRPC messages. Since all the field names between
these two classes are the same, it's easy to exchange data.</p>
<h1 id="importing-data-from-tasking-manager">Importing Data From Tasking Manager<a class="headerlink" href="#importing-data-from-tasking-manager" title="Permanent link">&para;</a></h1>
<p>If you have access to an actual postgres database with Tasking Manager
data in it, it can be imported into the <em>tm-admin</em> database schema. As
the tm-admin schema was originally based on the TM database schema,
this is mostly a direct copy. The only major change is in the tasking
manager, it only uses the integer value for an array, even when there
is a Enum already for this. This project uses the proper enums
instead, so some conversion is required.</p>
<p>Since the data structure for python is in the <em>types_tm.py</em> file,
it's easy to instantiate a class and get the name for the enum from
it's integer value.</p>
<div class="highlight"><pre><span></span><code>from tm_admin.types_tm import Userrole,
value = 1
role = Userrole(value)
print(role.name)
</code></pre></div>
<h2 id="importing-the-data">Importing the Data<a class="headerlink" href="#importing-the-data" title="Permanent link">&para;</a></h2>
<p>Data can be imported from a current Tasking Manager into the new
database schema. This can be done on a table by table process, or a
unified way. There are a few steps to import data from an existing
Tasking Manager database into the schema used by TM Admin. The TM
Admin schema is a superset, all columns in primary tables are the same
in TM and TM Admin. The main differences some of the tables from the
Tasking Manager have been incorporated into the primary tables to
reduce the amount of database queries required for some of the
endpoints.</p>
<p>Tasking Manager uses integers for Enum values when accessing the
database. TM Admin uses the proper Enum as it makes the code easier to
read and also forces all values to be in range. Once the primary table
is imported, then each table has to be updated with the small utility
tables. Those have all been replaced by using array columns, as most
where just two columns anyway. The list of utility tables is covered
later in this document.</p>
<p>It is assumed the data will only be imported once when upgrading
Tasking Manager to a new major version. This is so no data is lost.</p>
<h3 id="importing-a-table">Importing a Table<a class="headerlink" href="#importing-a-table" title="Permanent link">&para;</a></h3>
<p>To import only one table, initially use the <em>tmdb.py</em> program to
import the existing primary table into TM Admin. This only imports a
single table without any dependencies.</p>
<div class="highlight"><pre><span></span><code>tmdb.py -t users -v
</code></pre></div>
<p>Some of the primary tables from Tasking Manager have small auxilary
tables that then need to be imported. Since importing these updates an
existing record instead of inserting it, the primary table's data
obviously must be imported first.</p>
<p>To import the remaining tables into the array columns or a jsonb
column, each base class has support for their format. For example, to
import all the utility tables for the primary <em>users</em> table, do this:</p>
<div class="highlight"><pre><span></span><code>users/users.py -v
</code></pre></div>
<p>Note that the base classes have methods for importing everything, so
they can be utilized by other programs. The simple terminal based way
is of primary interest only to developers.</p>
<h3 id="importing-everything">Importing everything<a class="headerlink" href="#importing-everything" title="Permanent link">&para;</a></h3>
<p>While importing single tables is useful for development, most just
want to import everything. There is a utility program that does
this. Currently this goes through several steps required to setup a
database from scratch. This required you have created the database
already, but it has no tables defined.</p>
<div class="highlight"><pre><span></span><code>    # Generate all language binding files
    tmadmin_manage.py -v -c generate */*.yaml

    # Create the tables in the database
    tmadmin_manage.py -v -c create */*.sql

    # Import the data for the all primary tables.
    tmadmin_manage.py -v -c import

    # Import the data for just the users table
    tmadmin_manage.py -v -c import users
</code></pre></div>
<p>The default databases used by this program are <em>tm4</em> for the existing
data, and <em>tm_admin</em> for the new database. This can also be changed
using the <em>-i</em> and <em>-o</em> options to this program. There is more detail
on the tmadmin-manage.py program <a href="../tmadmin-manage/">on this page</a>.</p>
<h3 id="default-tables">Default Tables<a class="headerlink" href="#default-tables" title="Permanent link">&para;</a></h3>
<p>There are a few support tables that have preset values, like interests
or licenses. These are tables in the database because they can be
updated by the front end, which we can't do as a Enum. So these are
just default values that get indexed by the other tables.</p>
<h3 id="changes">Changes<a class="headerlink" href="#changes" title="Permanent link">&para;</a></h3>
<p>The existing TM database schema has been extended multiple times over
many years. One common theme is is often has multiple tables for a
single record type. Many of these are small, and consist primarily of
2 columns, usually two IDs. For example project_id and
user_id. There's much more detail on the existing database schema
<a href="../tmschema/">here</a>.</p>
<h4 id="user-table">User Table<a class="headerlink" href="#user-table" title="Permanent link">&para;</a></h4>
<p>Rather than have a separate <em>project_favorites</em> table, an array of projects has
been added as <em>favorite_projects</em>. Same with the <em>user_interests</em> and
<em>user_licenses</em>. <em>user_interests</em> is now an array of interest IDs, and
<em>user_licenses</em> is a single integer. The <em>users_with_email</em> columns
has been removed as it's possible to just query the database for users
with or without email addresses.</p>
<p>The <em>users</em> tables also absorbed the team_members table, adding these
columns to the <em>users</em> table as a jsonb array. This lets a user
have different functions or activity across multiple projects, which
is currently not supported by TM.</p>
<ul>
<li>join_request_notifications</li>
<li>team</li>
<li>active</li>
<li>function</li>
</ul>
<h4 id="projects-table">Projects Table<a class="headerlink" href="#projects-table" title="Permanent link">&para;</a></h4>
<p>There's a lot of project related tables.</p>
<p>From project_info:</p>
<ul>
<li>name</li>
<li>short_description</li>
<li>description</li>
<li>instructions</li>
</ul>
<p>From <strong>project_allowed_users</strong> table</p>
<ul>
<li>add to array of users</li>
</ul>
<p>From <strong>project_favorites</strong> table</p>
<ul>
<li>add to array of favorites</li>
</ul>
<p>From <strong>project_interests</strong> table</p>
<p>Right now a project has a single interest, but it'd be easy to exapand
to an array if multiple interest support was wanted.</p>
<ul>
<li>add integer column</li>
</ul>
<p>From <strong>project_custom_editors</strong> table</p>
<ul>
<li>appears to only be used for Rapid, but it's in the Enum for editors,
  so uneeded now</li>
</ul>
<p>From <strong>project_priority_areas</strong> tables</p>
<ul>
<li>add array of priority areas</li>
</ul>
<p>From <strong>project_teams</strong> table</p>
<ul>
<li>Add <em>team_id</em>, <em>team_role</em> to <em>teams</em> jsonb column.</li>
</ul>
<h4 id="organizations-table">Organizations Table<a class="headerlink" href="#organizations-table" title="Permanent link">&para;</a></h4>
<p>From <strong>organisation_managers</strong> tables into an array in the
organizations table.</p>
<ul>
<li>Add array of manager's user IDs</li>
</ul>
<h4 id="teams-table">Teams Table<a class="headerlink" href="#teams-table" title="Permanent link">&para;</a></h4>
<p>The teams table is based on OSM teams, but has been modified to
support any team.
Added columns from the <strong>team_members</strong> to the TM Admin <em>teams</em> jsonb
column.</p>
<ul>
<li>Team ID</li>
<li>function (mapper or manager)</li>
<li>active</li>
</ul>
<p>The <em>join_request_notifications</em> column in team_members has been left
out as this will be in the notification table.</p>
<h4 id="tasks-table">Tasks Table<a class="headerlink" href="#tasks-table" title="Permanent link">&para;</a></h4>
<p>This is obviously a heavily used table, and in the Tasking Manager, is
actually 5 tables. The goal here is to merge the tables together using
postgres arrays and jsonb columns to reduce the number of sequential
queries that need to be made for some API endpoints.</p>
<p>This table also has two indexes, as the task ID is not unique across
all projects, only within a single project. Both the task ID and
project ID need to be used in queries to get the right one.</p>
<ul>
<li>task_mapping_issues is now an Enum instead of a table</li>
</ul>
<h5 id="task-annotations">Task Annotations<a class="headerlink" href="#task-annotations" title="Permanent link">&para;</a></h5>
<p>This table appears not to be used by TM yet.</p>
<h5 id="task-history-table">Task History Table<a class="headerlink" href="#task-history-table" title="Permanent link">&para;</a></h5>
<p>The <em>task_history</em> table is now a jsonb column within the tasks
table. The <em>id</em> column is no longer needed, and the <em>project_id</em> and
<em>task_id</em> are already in the tasks table. In TM the action is a
string, which in TM Admin is a proper Enum, which is used instead. The
<em>action_text</em>, <em>action_date</em> and <em>user_id</em> are all preserved in the
jsonb column.</p>
<h5 id="task-mapping-issues">Task Mapping Issues<a class="headerlink" href="#task-mapping-issues" title="Permanent link">&para;</a></h5>
<p>This table in Tasking Manager must be new, as it contains little
data. It's basically a summary of the issue, like "Missed
Features(s)", or "Feature Geometry", with a count of how many features
have this issue.</p>
<p>Currently in the Tasking Manager there is an index into the history
table, which no longer exists. So the details of the issue are merged
with the task history jsonb column. This way the actual issue data is
part of the history.</p>
<h5 id="task-invalidation-history-table">Task Invalidation History Table<a class="headerlink" href="#task-invalidation-history-table" title="Permanent link">&para;</a></h5>
<p>This table has been merged into the <em>tasks</em> table as a jsonb column.</p>
<h5 id="notifications">Notifications<a class="headerlink" href="#notifications" title="Permanent link">&para;</a></h5>
<p>TODO: not implemented yet</p>
<h5 id="messages">Messages<a class="headerlink" href="#messages" title="Permanent link">&para;</a></h5>
<p>The messages table is imported with no changes.</p>
<h4 id="campaigns">Campaigns<a class="headerlink" href="#campaigns" title="Permanent link">&para;</a></h4>
<p>Currently in TM, campaigns are implemented as a primary table, and two
utility ones. These two utility tables gone in TM Admin, and replaced
by an array for each.</p>
<h2 id="testing-changes">Testing Changes<a class="headerlink" href="#testing-changes" title="Permanent link">&para;</a></h2>
<p>The code has been designed to be flexible and dynamic. Most of the
code extracts the keys &amp; values from the data itself. There is a lot
of looping through data structures to keep things self-adjusting.</p>
<p>A test suite has been created from the internal APIs used by the
backends of TM and FMTM. Many of the API endpoints are for
convienince, getting the value of a column from the database, or
updating existing data. Some are more functional, accessing one or
more tables to produce the correct output. These tests duplicate the
lower-level functionality the existing backends require.</p>

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">February 24, 2024</span>
      
    
  </small>
</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/hotosm/" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/hotosm" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.hotosm.org" target="_blank" rel="noopener" title="www.hotosm.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M352 256c0 22.2-1.2 43.6-3.3 64H163.3c-2.2-20.4-3.3-41.8-3.3-64s1.2-43.6 3.3-64h185.4c2.2 20.4 3.3 41.8 3.3 64zm28.8-64h123.1c5.3 20.5 8.1 41.9 8.1 64s-2.8 43.5-8.1 64H380.8c2.1-20.6 3.2-42 3.2-64s-1.1-43.4-3.2-64zm112.6-32H376.7c-10-63.9-29.8-117.4-55.3-151.6 78.3 20.7 142 77.5 171.9 151.6zm-149.1 0H167.7c6.1-36.4 15.5-68.6 27-94.7 10.5-23.6 22.2-40.7 33.5-51.5C239.4 3.2 248.7 0 256 0s16.6 3.2 27.8 13.8c11.3 10.8 23 27.9 33.5 51.5 11.6 26 20.9 58.2 27 94.7zm-209 0H18.6c30-74.1 93.6-130.9 172-151.6-25.5 34.2-45.3 87.7-55.3 151.6zM8.1 192h123.1c-2.1 20.6-3.2 42-3.2 64s1.1 43.4 3.2 64H8.1C2.8 299.5 0 278.1 0 256s2.8-43.5 8.1-64zm186.6 254.6c-11.6-26-20.9-58.2-27-94.6h176.6c-6.1 36.4-15.5 68.6-27 94.6-10.5 23.6-22.2 40.7-33.5 51.5-11.2 10.7-20.5 13.9-27.8 13.9s-16.6-3.2-27.8-13.8c-11.3-10.8-23-27.9-33.5-51.5zM135.3 352c10 63.9 29.8 117.4 55.3 151.6-78.4-20.7-142-77.5-172-151.6h116.7zm358.1 0c-30 74.1-93.6 130.9-171.9 151.6 25.5-34.2 45.2-87.7 55.3-151.6h116.6z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.81fa17fe.min.js"></script>
      
    
  </body>
</html>